#!/usr/bin/env bash
set -euo pipefail

# 1) Install Node.js 22.x via NodeSource (includes Corepack)
echo "ðŸ”§ Adding NodeSource repo for Node.js 22.x and installing nodejsâ€¦"
curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -  # adds the NodeSource PPA :contentReference[oaicite:0]{index=0}
sudo apt-get install -y nodejs                                  # installs Node.js 22.x (with Corepack bundled) :contentReference[oaicite:1]{index=1}

# 2) Enable Corepack & prepare Yarn v4.5.2
echo "âš™ï¸  Enabling Corepack and activating Yarn@4.5.2â€¦"
npx corepack yarn --version   # â†’ 4.5.2
npx corepack yarn install --mode=skip-build --no-immutable   # pulls in your workspaces

# 3) Configure Yarn to use node_modules instead of PnP
echo "ðŸ“¦ Configuring Yarn for a node_modules layoutâ€¦"
cat > .yarnrc.yml <<EOF                                      # Yarn settings belong in .yarnrc.yml :contentReference[oaicite:4]{index=4}
nodeLinker: node-modules
EOF

# 4) Clean any residual PnP artifacts and cache
echo "ðŸ§¹ Cleaning old PnP files and Yarn cacheâ€¦"
rm -rf .pnp.* .yarn/cache
npx corepack yarn cache clean                                             # resets Yarnâ€™s global cache :contentReference[oaicite:5]{index=5}

# 5) Install all dependencies into node_modules
echo "ðŸ“¥ Installing all workspacesâ€¦"
npx corepack yarn install                                    # installs every workspace into node_modules :contentReference[oaicite:6]{index=6}

# 6) Add missing workspace-specific devDependencies
echo "ðŸ”§ Adding webpack & html-webpack-plugin to the heptagon workspaceâ€¦"
npx corepack yarn workspace heptagon add -D webpack html-webpack-plugin  # satisfies html-webpack-pluginâ€™s peer requirement :contentReference[oaicite:7]{index=7}

# 7) Align root-level peer dependencies
# echo "âš–ï¸  Aligning React and MUI peer versions at the rootâ€¦"
# npx corepack yarn add -W @mui/icons-material@^6.4.8 react-dom@^18.2.0  # matches peer ranges for react-card-flip, etc. :contentReference[oaicite:8]{index=8}

# 8) Run your clean build to verify success
echo "ðŸš€ Running build-clean to verify everything compilesâ€¦"
npx corepack yarn build-clean                                 # runs your turbo-powered clean build :contentReference[oaicite:9]{index=9}

echo "âœ… Jules environment is fully set up and build-clean passed!"